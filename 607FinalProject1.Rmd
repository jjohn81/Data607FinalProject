---
title: "Data 607 - Final Project"
author: "Joby John / Peter Kowalchuk"
date: "11/28/2018"
output:
  html_document:
    toc: true
    toc_float: true
    theme: united
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#Introduction

Every two years our nation goes thru the process of electing out government officials. It seems every year the bipartisan rhetoric gets stronger and strong. Many claims are made on what happens to the economy when either party is in control, of the President’s office, the Senate or the House. Coming right out of the mid-terms, looking at what next year brings economically is certainly of interest to all.

Gathering data from the Federal Reserve’s FRED service ( https://fred.stlouisfed.org ) and from scrapping results from elections from the web (such as https://transition.fec.gov/pubrec/electionresults.shtm), we can build a model of what next year has in store. 

We would start out by selecting economic indicators from the FRED site. Selecting interesting indicators will be done using  Wickham’s  workflow. Data will be imported, made tidy, possible transformations applied and then thru visualization the most “interesting” indicators will be selected.

 Electoral data will include the number of senate and house seats in congress the year after an election. Using this data together with our economic indicators, models will be built to predict a certain economic indicator. Several models can be used, presenting results from each in graphical form. We can also classify monthly economic data with a good, medium and poor economy tag. Once we do this we can train a classifier to tell us what the economic outlook might be given an input of congress seats.

There seems to be the notion that Python is a better language for machine learning and running classifiers. As a stretch got for this project, to experiment with something not covered in class, we can try running python code in RStudio using the reticulate library. If this is possible, training a classifier using the popular sci-kitlearn package in Python and comparing them with results in r, could give us a clue into which is better at machine learning.

#Workflow

We will use Hadley Wickman's Tidy Workflow as show below.

![](TidyWorkflow.png)

###Loading required libraries

```{r}
library("rvest")
library(tidyr)
require(mongolite)
library(dplyr)
library(ggplot2)

library(FredR)
library(pipeR)
library(kableExtra)
```

#Import Data

##Economic Indicators Dataset

The Federal Reserve's database has a selection of economic indicators. For this analysis we will look at GDP (Gross Domestic Product) indicators as a proxy for the health of the economy. To select an indicator we can first explore GDP indicators available.

```{r}
api.key = "4844eb6986119824760163e60bddd945"
fred<-FredR(api.key)

gdp.series <- fred$series.search("GDP")
gdp.series %>% kable() %>% kable_styling() %>% scroll_box(height = "400px")
```

From this selection we decide to use two indicators: Gross Domestic Product per Capita and Real Personal Consumption Expenditures.

```{r}
#Gross domestic product
gdp <- fred$series.observations(series_id = 'A939RX0Q048SBEA')
head(gdp,n=100) %>% kable() %>% kable_styling() %>% scroll_box(height = "400px")

#Real Personal Consumption Expenditures
rpce <- fred$series.observations(series_id = 'DPCERL1Q225SBEA')
head(rpce,n=100) %>% kable() %>% kable_styling() %>% scroll_box(height = "400px")
```

##Electoral Data

For this analysis we will need data showing the number of congress and senate seats occupied by both parties. This data was scrapped from The University of Wisconsin's web page. 

```{r}
url <- "https://web.education.wisc.edu/nwhillman/index.php/2017/02/01/party-control-in-congress-and-state-legislatures/"
congress_by_party <- url %>%
  read_html() %>%
  html_table()
# this is wide format . 
congress_by_party <- congress_by_party[[1]]
head(congress_by_party,n=100) %>% kable() %>% kable_styling() %>% scroll_box(height = "400px")
```

#Tidy & Transform

##Economic Indicators Dataset

Since our analysis will be annual based, as senate and congress seats change biannually, the economic data gathered from the Federal Reserve site needs to be scaled up from quarterly to annually.

```{r}
#Scale up data from quarterly to annual
gdp$date<-substring(gdp$date,1,4)
gdp$value<-as.numeric(gdp$value)
gdp$value<-gdp$value/4
gdp<-gdp %>% group_by(date) %>% summarise(value=sum(value))
gdp <- gdp %>% mutate(Diff = (value - lag(value))/lag(value)) # we add a column for the GDP difference between each year

rpce$date<-substring(rpce$date,1,4)
rpce$value<-as.numeric(rpce$value)
rpce$value<-rpce$value/4
rpce<-rpce %>% group_by(date) %>% summarise(value=sum(value))
```

###Final Economic Indicators Dataset 

```{r}
gdp %>% kable() %>% kable_styling() %>% scroll_box(height = "400px")
rpce %>% kable() %>% kable_styling() %>% scroll_box(height = "400px")
```

**Adding dataset to Mongo database**

```{r}
InsertRecords<- function(data) {
  data607_final_project <- mongo( db = "DATA607", collection = "DATA607_Final_Project")
  x <-data607_final_project$insert(data)
  rm(data607_final_project)
  gc()
  x
}

InsertRecords(gdp)
InsertRecords(rpce)
```

##Electoral Dataset

For our analysis, electoral data is taken into a long table format from its original wide table format in the University's website.

```{r}
# conver to long format. year, party, chamber, seats
congress_by_party  <- congress_by_party %>% select(1:7)
 
names(congress_by_party) <- c('Year',
                              paste(congress_by_party[1,2], congress_by_party[2,2]),
                              paste(congress_by_party[1,3], congress_by_party[2,3]),
                              paste(congress_by_party[1,4], congress_by_party[2,4]),
                              paste(congress_by_party[1,5], congress_by_party[2,5]),
                              paste(congress_by_party[1,6], congress_by_party[2,6]),
                              paste(congress_by_party[1,7], congress_by_party[2,7])
                              )
congress_by_party <- congress_by_party %>%
                    mutate(Senate =ifelse(congress_by_party$`Senate Dem` > congress_by_party$`Senate Rep`, "Dem", ifelse(congress_by_party$`Senate Dem` == congress_by_party$`Senate Rep`, 'Hung','Rep')))

congress_by_party <- congress_by_party %>%
                    mutate(House =ifelse(congress_by_party$`House Dem` > congress_by_party$`House Rep`, "Dem", ifelse(congress_by_party$`House Dem` == congress_by_party$`House Rep`, 'Hung','Rep')))

congress_by_party<- congress_by_party %>%
                     select(Year, House, Senate)
congress_by_party<- congress_by_party[c(3:22),] %>% arrange(desc(Year))

congress_by_party$Year <- as.numeric(congress_by_party$Year)
 
# Fill int the data for the year between elections
congress_by_party_between_years <- congress_by_party

congress_by_party_between_years$Year <-congress_by_party_between_years$Year+1

congress <- rbind(congress_by_party, congress_by_party_between_years)
```

###Final Electoral Dataset

```{r}
 
congress %>% kable() %>% kable_styling() %>% scroll_box(height = "400px")
```

**Adding dataset to Mongo database**

```{r}
InsertRecords(congress)
```

**Read data from Mongo**

```{r}
# I will add logic to retrieve data from mongo. This way we are using two data sources. I will read gdp and rpce
# data back and store them in the same variable. I will alos try to do the join in mongo

# mongoCongress <- mongo( db = "DATA607", collection = "DATA607_Final_Project")
#congress <- mongoCongress$find('{}')
```


#Visualize

**GDP Data**

As can be seen below, the GDP per capita is a value that increases over time. GDP is dependent on population, but also on other factors such as inflation.

```{r}
plot(gdp$date,gdp$value)
```

For our analysis we will use the difference in GDP year over year, normalized over the previous value of GDP. This is that is calculated in the datasets Diff column

```{r}
plot(gdp$date,gdp$Diff)
```

```{r}
gdp_congress<-gdp
gdp_congress$date <- as.numeric(gdp_congress$date) 
gdp_congress$Diff <- as.double(gdp_congress$Diff)

 
gdp_congress <- gdp_congress%>%inner_join(congress,by =c('date'='Year') )
 
ggplot(gdp_congress, aes(x=date, y=Diff, shape=House, color=House)) +
  geom_point()

ggplot(gdp_congress, aes(x=date, y=Diff, shape=Senate, color=Senate)) +
  geom_point() 

```

**RPCE Data*

```{r}
rpce_congress<-rpce
rpce_congress$date <- as.numeric(rpce_congress$date) 
rpce_congress$value <- as.double(rpce_congress$value)

 
rpce_congress <- rpce_congress%>%inner_join(congress,by =c('date'='Year') )
 
ggplot(rpce_congress, aes(x=date, y=value, shape=House, color=House)) +
  geom_point()

ggplot(rpce_congress, aes(x=date, y=value, shape=Senate, color=Senate)) +
  geom_point() 

```


#Model

##Economic Indicator Predictor

###GDP Model

A simple model can determine the expected GDP normilized difference year on year value for a year where the Democratic or Republican party is majority in each chamber.

**House controlled by the Democratic Party**
```{r}
gdp_congress_house_dem<-subset(gdp_congress,gdp_congress$House=="Dem")
mean(gdp_congress_house_dem$Diff)
```

**House controlled by the Republican Party**
```{r}
gdp_congress_house_rep<-subset(gdp_congress,gdp_congress$House=="Rep")
mean(gdp_congress_house_rep$Diff)
```


**Senate controlled by the Democratic Party**
```{r}
gdp_congress_senate_dem<-subset(gdp_congress,gdp_congress$Senate=="Dem")
mean(gdp_congress_senate_dem$Diff)
```

**Senate controlled by the Republican Party**
```{r}
gdp_congress_senate_rep<-subset(gdp_congress,gdp_congress$Senate=="Rep")
mean(gdp_congress_senate_rep$Diff)
```

**Senate controlled by the Republican Party and House by the Democratic Party**

```{r}
gdp_congress_senate_rep_house_dem<-subset(gdp_congress,rpce_congress$Senate=="Rep" & gdp_congress$House=="Dem")
mean(gdp_congress_senate_rep_house_dem$Diff)
```


###RPCE Models

**RPCE prediced by majority Party**

A simple model can determine the expected RPCE value for a year where the Democratic or Republican party is majority in each chamber.

**House controlled by the Democratic Party**
```{r}
rpce_congress_house_dem<-subset(rpce_congress,rpce_congress$House=="Dem")
mean(rpce_congress_house_dem$value)
```

**House controlled by the Republican Party**
```{r}
rpce_congress_house_rep<-subset(rpce_congress,rpce_congress$House=="Rep")
mean(rpce_congress_house_rep$value)
```


**Senate controlled by the Democratic Party**
```{r}
rpce_congress_senate_dem<-subset(rpce_congress,rpce_congress$Senate=="Dem")
mean(rpce_congress_senate_dem$value)
```

**Senate controlled by the Republican Party**
```{r}
rpce_congress_senate_rep<-subset(rpce_congress,rpce_congress$Senate=="Rep")
mean(rpce_congress_senate_rep$value)
```

**Senate controlled by the Republican Party and House by the Democratic Party**

```{r}
rpce_congress_senate_rep_house_dem<-subset(rpce_congress,rpce_congress$Senate=="Rep" & rpce_congress$House=="Dem")
mean(rpce_congress_senate_rep_house_dem$value)
```


**RPCE prediced by number of Democratic Party seats in congress**

To derive this model we build a linear regression of RPCE agaisnt the number of Democratic seats in each chamber.

**House**

```{r}

```


##Economy Health Classifier

###Classifier in R

###Classifier in Python

#Communicate

Based on the analysis here presented, this is what we can expect as an economic outlook for next year.

**GDP**

Since the House will be lead by the Democratic party we expect GDP normilized difference to be around 0.0146259. But since the Senate will be leading the Senate, GDP normilized difference should come at 0.02084138. Since we are looking at a divided congress, expected GDP normilized difference is that for a Senate controlled by Republicans and House by Democrats, which is **0.01760847**

**RPCE**

Since the House will be lead by the Democratic party we expect RPCE to be around 2.62625. But since the Senate will be leading the Senate, RPCE should come at 3.49375. Since we are looking at a divided congress, expected RPCE is that for a Senate controlled by Republicans and House by Democrats, which is **3.266667**


